name: Deploy to Cloud Run (staging)
on:
  workflow_run:
    workflows: ["Build & Push to Artifact Registry (Hardened)"]
    types: [completed]
  workflow_dispatch: {}

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      id-token: write
      contents: read
    env:
      PROJECT_ID: github-automation-470314
      GAR_LOCATION: asia-south1
      REPO_NAME: apps
      IMAGE_NAME: ifra-build-deploy
      SERVICE_ACCOUNT_EMAIL: gh-actions-ar-writer@github-automation-470314.iam.gserviceaccount.com
      WIF_PROVIDER: projects/755744988797/locations/global/workloadIdentityPools/github-oidc-pool/providers/github-provider
      RUN_SERVICE_NAME: ifra-build-deploy
      RUN_REGION: asia-south1
    steps:
      - uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Deploy commit image
        run: |
          IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.event.workflow_run.head_sha || github.sha }}"
          gcloud run deploy "${{ env.RUN_SERVICE_NAME }}" --image="$IMAGE" --region="${{ env.RUN_REGION }}" --allow-unauthenticated --platform=managed
